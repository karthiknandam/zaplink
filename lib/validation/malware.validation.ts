const API_KEY = process.env.GOOGLE_API_KEY || "";

export async function checkUrlSafety(url: string) {
  try {
    const payload = {
      client: {
        clientId: "zaplink",
        clientVersion: "1.0",
      },
      threatInfo: {
        threatTypes: ["MALWARE", "SOCIAL_ENGINEERING", "UNWANTED_SOFTWARE"],
        platformTypes: ["ANY_PLATFORM"],
        threatEntryTypes: ["URL"],
        threatEntries: [{ url }],
      },
    };

    const res = await fetch(
      `https://safebrowsing.googleapis.com/v4/threatMatches:find?key=${API_KEY}`,
      { method: "POST", body: JSON.stringify(payload) }
    );

    const data = await res.json();

    console.log(data);
    return Object.keys(data).length === 0; // safe if empty
  } catch (error) {
    throw new Error(error as string);
  }
}
